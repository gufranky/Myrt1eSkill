name: Build and Release

on:
  push:
    tags:
      - 'v[0-9]+\.[0-9]+\.0'  # åªåœ¨ä¸»ç‰ˆæœ¬æˆ–æ¬¡ç‰ˆæœ¬å˜åŒ–æ—¶æ„å»ºï¼ˆå¦‚ v2.1.0ï¼‰ï¼Œè¡¥ä¸ç‰ˆæœ¬ä¸æ„å»ºï¼ˆå¦‚ v2.1.1ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: Release

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # å®‰è£… .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # æ¢å¤ NuGet åŒ…
      - name: Restore Dependencies
        run: dotnet restore MyrtleSkill.csproj

      # ç¼–è¯‘é¡¹ç›®
      - name: Build Project
        run: |
          dotnet build MyrtleSkill.csproj --configuration ${{ env.CONFIGURATION }} --no-restore

      # åˆ›å»ºå‘å¸ƒç›®å½•ç»“æ„
      - name: Create Release Structure
        run: |
          mkdir -p release/plugins/MyrtleSkill
          mkdir -p release/gamedata
          mkdir -p release/addons/counterstrikesharp/addons/MyrtleSkill

      # å¤åˆ¶ç¼–è¯‘å¥½çš„ DLL
      - name: Copy DLL
        run: |
          cp bin/${{ env.CONFIGURATION }}/net8.0/MyrtleSkill.dll release/addons/counterstrikesharp/addons/MyrtleSkill/

      # å¤åˆ¶ gamedata æ–‡ä»¶
      - name: Copy GameData
        run: |
          cp gamedata/MyrtleSkill.gamedata.json release/gamedata/

      # å¤åˆ¶é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Copy Config Files
        run: |
          if [ -f config.json ]; then
            cp config.json release/addons/counterstrikesharp/addons/MyrtleSkill/
          fi

      # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
      - name: Create Version Info
        run: |
          echo "MyrtleSkill Plugin" > release/VERSION.txt
          echo "Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> release/VERSION.txt
          echo "Git Commit: ${{ github.sha }}" >> release/VERSION.txt
          echo "Git Tag: ${{ github.ref_name }}" >> release/VERSION.txt

      # åˆ›å»º ZIP åŒ…
      - name: Create ZIP Package
        run: |
          cd release
          zip -r ../MyrtleSkill-${{ github.ref_name }}.zip .
          cd ..

      # è·å–ç‰ˆæœ¬å·ï¼ˆç”¨äº Release æ ‡é¢˜ï¼‰
      - name: Get Version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      # åˆ›å»º GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: MyrtleSkill Plugin ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ğŸ® MyrtleSkill Plugin ${{ steps.get_version.outputs.VERSION }}

            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            1. ä¸‹è½½ `MyrtleSkill-${{ steps.get_version.outputs.VERSION }}.zip`
            2. è§£å‹åˆ°æœåŠ¡å™¨çš„ `csgo/addons/counterstrikesharp/` ç›®å½•
            3. é‡å¯æœåŠ¡å™¨æˆ–åŠ è½½æ’ä»¶

            ### ğŸ“‹ å®‰è£…è·¯å¾„
            - **æ’ä»¶ DLL**: `addons/counterstrikesharp/addons/MyrtleSkill/MyrtleSkill.dll`
            - **é…ç½®æ–‡ä»¶**: `addons/counterstrikesharp/addons/MyrtleSkill/config.json`
            - **æ¸¸æˆæ•°æ®**: `gamedata/MyrtleSkill.gamedata.json`

            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - 37 ä¸ªéšæœºå¨±ä¹äº‹ä»¶
            - 24 ä¸ªç©å®¶æŠ€èƒ½
            - å¼€å±€ç¦åˆ©ç³»ç»Ÿ
            - æœºå™¨äººæ§åˆ¶
            - ä½ç½®è®°å½•å™¨

            ### ğŸ“„ è®¸å¯è¯
            GNU General Public License v3.0

            ---
            **å®Œæ•´å˜æ›´æ—¥å¿—**: https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.VERSION }}
          files: MyrtleSkill-${{ github.ref_name }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆç”¨äºè°ƒè¯•ï¼‰
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyrtleSkill-${{ github.ref_name }}
          path: MyrtleSkill-${{ github.ref_name }}.zip
          retention-days: 30
